name: Create Release

on:
  push:
    branches:
      - master
      - main

jobs:
  create-release:
    if: "startsWith(github.event.head_commit.message, 'chore: bump version to v')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract version
        id: find_version
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"

          if [[ "$MESSAGE" =~ v([0-9]+\.[0-9]+\.[0-9]+([-a-z0-9\.]*)?) ]]; then
            VERSION="v${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "Failed to extract version"
            exit 1
          fi

      - name: Tag release
        run: |
          VERSION=${{ steps.find_version.outputs.version }}
          git tag -f "$VERSION"
          git push origin "$VERSION" --force

      - name: Generate grouped release notes
        run: |
          VERSION=${{ steps.find_version.outputs.version }}
          COMMIT=${{ github.sha }}
          REPO_URL="https://github.com/${{ github.repository }}"
          PREV_TAG=$(git describe --tags --abbrev=0 --match "v*" --exclude "$VERSION" 2>/dev/null || echo "")

          echo "" > RELEASE_NOTES.md

          # Function to extract commits by type between prev tag and this commit
          get_commits_by_type() {
            local type=$1
            if [ -n "$PREV_TAG" ]; then
              git log "$PREV_TAG..$COMMIT" --pretty=format:"%s|%H" \
                | grep -E "^$type(\(|:)" \
                | grep -Ev "bump version to v[0-9]+\.[0-9]+\.[0-9]+" || true
            else
              git log --pretty=format:"%s|%H" "$COMMIT" \
                | grep -E "^$type(\(|:)" \
                | grep -Ev "bump version to v[0-9]+\.[0-9]+\.[0-9]+" || true
            fi
          }

          write_section() {
            local section_title="$1"
            local type="$2"
            COMMITS=$(get_commits_by_type "$type")
            if [ -n "$COMMITS" ]; then
              echo "## $section_title" >> RELEASE_NOTES.md
              echo "$COMMITS" | while IFS="|" read -r subject hash; do
                clean_subject=$(echo "$subject" | sed -E "s/^$type(\([^)]+\))?: //")
                echo "- $clean_subject ([\`$(echo $hash | cut -c1-7)\`]($REPO_URL/commit/$hash))" >> RELEASE_NOTES.md
              done
              echo -e "\n" >> RELEASE_NOTES.md
            fi
          }

          # Generate grouped sections
          write_section "âœ¨ Features" "feat"
          write_section "ðŸ› Fixes" "fix"
          write_section "ðŸ§¹ Chores" "chore"
          write_section "ðŸ§ª Tests" "test"
          write_section "ðŸ“ Docs" "docs"

          # Add full changelog link
          if [ -n "$PREV_TAG" ]; then
            echo -e "**Full Changelog:** $REPO_URL/compare/$PREV_TAG...$VERSION" >> RELEASE_NOTES.md
          fi

          echo "---- RELEASE_NOTES.md ----"
          cat RELEASE_NOTES.md

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: latest

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install
        working-directory: apps/mobile

      - name: Build app
        id: build_app
        run: |
          eas build --platform android --profile preview --non-interactive --json > build.json
          BUILD_URL=$(jq -r '.[0].artifacts.buildUrl' build.json)
          echo "BUILD_URL=$BUILD_URL" >> $GITHUB_OUTPUT
        working-directory: apps/mobile

      - name: Download APK file
        run: |
          wget -O watchvault-${{ steps.find_version.outputs.version }}.apk "${{ steps.build_app.outputs.BUILD_URL }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.find_version.outputs.version }}
          name: ${{ steps.find_version.outputs.version }}
          body_path: ${{ github.workspace }}/RELEASE_NOTES.md
          files: ${{ github.workspace }}/watchvault-${{ steps.find_version.outputs.version }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
